<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NGL Document Merger</title>

  <!-- ── CDN Dependencies ── -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    /* ─── Base ─── */
    *, *::before, *::after { box-sizing: border-box; }
    body {
      margin: 0;
      background: #0f172a;
      color: #f1f5f9;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      min-height: 100vh;
    }

    /* ─── Scrollbars ─── */
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }

    /* ─── Buttons ─── */
    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 10px 20px; border-radius: 8px; font-size: 0.875rem;
      font-weight: 600; cursor: pointer; border: none;
      transition: all 0.18s; user-select: none; white-space: nowrap;
    }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; pointer-events: none; }
    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      border: 1px solid #3b82f6; color: #fff;
    }
    .btn-primary:hover { background: linear-gradient(135deg, #3b82f6, #2563eb); transform: translateY(-1px); }
    .btn-secondary {
      background: #1e293b; border: 1px solid #334155; color: #94a3b8;
    }
    .btn-secondary:hover { border-color: #475569; color: #e2e8f0; }
    .btn-danger { background: #7f1d1d; border: 1px solid #991b1b; color: #fca5a5; }
    .btn-danger:hover { background: #991b1b; }
    .btn-success { background: #14532d; border: 1px solid #16a34a; color: #86efac; }
    .btn-success:hover { background: #166534; }

    /* ─── Mode Badge ─── */
    .mode-badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 4px 12px; border-radius: 999px;
      font-size: 0.7rem; font-weight: 700;
      letter-spacing: 0.08em; text-transform: uppercase;
    }
    .badge-dot { width: 6px; height: 6px; border-radius: 50%; }
    .mode-idle   { background: #1e293b; color: #64748b; border: 1px solid #334155; }
    .mode-auto   { background: rgba(37,99,235,0.15); color: #60a5fa; border: 1px solid #1d4ed8; }
    .mode-manual { background: rgba(22,163,74,0.15); color: #4ade80; border: 1px solid #15803d; }
    .idle-dot   { background: #475569; }
    .auto-dot   { background: #3b82f6; box-shadow: 0 0 6px #3b82f6; }
    .manual-dot { background: #22c55e; box-shadow: 0 0 6px #22c55e; }

    /* ─── Drop Zones ─── */
    .drop-zone {
      border: 2px dashed #334155; border-radius: 12px;
      padding: 28px 20px; text-align: center; cursor: pointer;
      transition: all 0.18s; background: rgba(15,23,42,0.6);
    }
    .drop-zone:hover { border-color: #475569; background: rgba(30,41,59,0.6); }
    .drop-zone.drag-over { border-color: #3b82f6; background: rgba(59,130,246,0.08); }
    .drop-zone.has-file { border-color: #15803d; border-style: solid; background: rgba(22,163,74,0.05); }

    /* ─── PDF Cards ─── */
    .pdf-card {
      display: flex; align-items: center; gap: 10px;
      background: rgba(30,41,59,0.7); border: 1px solid #334155;
      border-radius: 10px; padding: 11px 12px; margin-bottom: 7px;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .pdf-card:hover { border-color: #475569; }
    .drag-handle { cursor: grab; color: #475569; flex-shrink: 0; padding: 2px; }
    .drag-handle:hover { color: #94a3b8; }
    .sortable-ghost { opacity: 0.25; background: #334155; }
    .sortable-chosen { border-color: #3b82f6 !important; box-shadow: 0 0 0 2px rgba(59,130,246,0.3); }
    .sortable-drag { box-shadow: 0 8px 25px rgba(0,0,0,0.5); }

    /* ─── Container Groups (Auto Mode) ─── */
    .container-group {
      background: rgba(15,23,42,0.8); border: 1px solid #1e293b;
      border-radius: 10px; padding: 12px; margin-bottom: 8px;
    }
    .container-group.matched { border-color: rgba(22,163,74,0.4); }
    .container-group.unmatched { border-color: rgba(245,158,11,0.3); }
    .container-group-header {
      display: flex; align-items: center; gap: 8px; margin-bottom: 6px;
    }
    .matched-file-row {
      display: flex; align-items: center; gap: 6px;
      padding: 4px 8px; background: rgba(30,41,59,0.6);
      border-radius: 6px; margin-bottom: 3px;
    }

    /* ─── Status Log ─── */
    #statusLog {
      background: #020817; border: 1px solid #1e293b;
      border-radius: 10px; padding: 14px; height: 210px;
      overflow-y: auto; font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 0.72rem; line-height: 1.7;
    }
    .log-info    { color: #64748b; }
    .log-success { color: #4ade80; }
    .log-error   { color: #f87171; }
    .log-warning { color: #fbbf24; }
    .log-time    { color: #1e293b; }
    .log-prefix  { font-weight: 700; }

    /* ─── Processing spinner ─── */
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner { animation: spin 0.8s linear infinite; display: inline-block; }

    /* ─── Section labels ─── */
    .section-label {
      display: flex; align-items: center; gap: 7px;
      font-size: 0.7rem; font-weight: 700; letter-spacing: 0.1em;
      text-transform: uppercase; color: #475569; margin-bottom: 10px;
    }

    /* ─── Queue wrapper ─── */
    #queueWrapper {
      min-height: 180px; max-height: 360px; overflow-y: auto; padding-right: 2px;
    }

    /* ─── Failure report ─── */
    #failureReport {
      background: rgba(127,29,29,0.15); border: 1px solid rgba(153,27,27,0.4);
      border-radius: 10px; padding: 12px; margin-top: 10px;
    }
    .failure-row {
      display: flex; align-items: center; gap: 8px;
      padding: 4px 0; border-bottom: 1px solid rgba(153,27,27,0.2); font-size: 0.8rem;
    }
    .failure-row:last-child { border-bottom: none; }

    /* ─── Progress bar ─── */
    #progressBar { transition: width 0.3s ease; }

    /* ─── Tooltip ─── */
    [data-tip] { position: relative; }
    [data-tip]:hover::after {
      content: attr(data-tip); position: absolute; bottom: 100%; left: 50%;
      transform: translateX(-50%); background: #1e293b; color: #e2e8f0;
      padding: 4px 8px; border-radius: 5px; font-size: 0.7rem; white-space: nowrap;
      margin-bottom: 6px; border: 1px solid #334155; pointer-events: none; z-index: 100;
    }
  </style>
</head>

<body>

<!-- ═══════════════════════════════════════════ HEADER ═══════════════════════════════════════════ -->
<header style="background:#0a111f; border-bottom:1px solid #1e293b; position:sticky; top:0; z-index:50;">
  <div style="max-width:1280px; margin:0 auto; padding:0 24px; height:60px; display:flex; align-items:center; justify-content:space-between; gap:16px;">

    <!-- Logo + Title -->
    <div style="display:flex; align-items:center; gap:12px;">
      <div style="width:36px; height:36px; background:linear-gradient(135deg,#1d4ed8,#0f172a); border:1px solid #2563eb; border-radius:9px; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
        <!-- File layers icon -->
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/>
        </svg>
      </div>
      <div>
        <div style="font-size:1rem; font-weight:700; color:#f1f5f9; line-height:1.2;">NGL Document Merger</div>
        <div style="font-size:0.68rem; color:#475569; margin-top:1px;">Logistics Document Processing Utility &nbsp;·&nbsp; 100% Client-Side</div>
      </div>
    </div>

    <!-- Right side controls -->
    <div style="display:flex; align-items:center; gap:10px; flex-shrink:0;">
      <span id="modeBadge" class="mode-badge mode-idle">
        <span id="modeDot" class="badge-dot idle-dot"></span>
        <span id="modeLabel">Idle</span>
      </span>
      <button class="btn btn-secondary" style="padding:7px 14px; font-size:0.78rem;" onclick="clearAll()" data-tip="Reset everything">
        <!-- Trash icon -->
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/>
        </svg>
        Clear All
      </button>
    </div>
  </div>
</header>


<!-- ═══════════════════════════════════════════ MAIN ═══════════════════════════════════════════ -->
<main style="max-width:1280px; margin:0 auto; padding:28px 24px;">
  <div style="display:grid; grid-template-columns: 1fr 1fr; gap:24px;" id="mainGrid">

    <!-- ═══════════════ LEFT PANEL ═══════════════ -->
    <div style="display:flex; flex-direction:column; gap:20px;">

      <!-- ── Step 1: Excel Drop Zone ── -->
      <div>
        <div class="section-label">
          <!-- Grid icon -->
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
          </svg>
          Step 1 — Excel Manifest <span style="color:#334155; font-weight:400; text-transform:none; letter-spacing:0;">(Optional — enables Auto Mode)</span>
        </div>

        <div id="excelDropZone" class="drop-zone" onclick="document.getElementById('excelInput').click()">
          <div id="excelDropContent">
            <div style="display:flex; justify-content:center; margin-bottom:12px;">
              <!-- Spreadsheet icon -->
              <svg width="34" height="34" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/>
              </svg>
            </div>
            <div style="font-size:0.875rem; font-weight:600; color:#e2e8f0;">Drop Excel Manifest</div>
            <div style="font-size:0.75rem; color:#64748b; margin-top:4px;">Needs a <strong style="color:#94a3b8;">Container Number</strong> column to match PDFs automatically</div>
            <div style="font-size:0.7rem; color:#334155; margin-top:8px;">.xlsx &nbsp;·&nbsp; .xls &nbsp;·&nbsp; .csv</div>
          </div>
          <!-- File loaded state (hidden by default) -->
          <div id="excelLoadedState" style="display:none; align-items:center; gap:10px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            <div style="flex:1; text-align:left; min-width:0;">
              <div id="excelFileName" style="font-size:0.8rem; font-weight:600; color:#e2e8f0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div>
              <div id="excelFileSub" style="font-size:0.7rem; color:#4ade80; margin-top:2px;"></div>
            </div>
            <button onclick="event.stopPropagation(); removeExcel()" style="background:none; border:none; cursor:pointer; color:#475569; flex-shrink:0; padding:4px;" onmouseover="this.style.color='#f87171'" onmouseout="this.style.color='#475569'">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          </div>
        </div>
        <input type="file" id="excelInput" accept=".xlsx,.xls,.csv" style="display:none;" onchange="handleExcelInputChange(this)" />
      </div>


      <!-- ── Step 2: PDF Drop Zone ── -->
      <div>
        <div class="section-label">
          <!-- File icon -->
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/>
          </svg>
          Step 2 — PDF Documents
        </div>

        <div id="pdfDropZone" class="drop-zone" onclick="document.getElementById('pdfInput').click()">
          <div style="display:flex; justify-content:center; margin-bottom:12px;">
            <svg width="34" height="34" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>
            </svg>
          </div>
          <div style="font-size:0.875rem; font-weight:600; color:#e2e8f0;">Drop PDF Documents Here</div>
          <div style="font-size:0.75rem; color:#64748b; margin-top:4px;">Invoices, PODs, or any PDF files &nbsp;·&nbsp; Multiple files supported</div>
          <div style="font-size:0.7rem; color:#334155; margin-top:8px;">.pdf only</div>
        </div>
        <input type="file" id="pdfInput" accept=".pdf" multiple style="display:none;" onchange="handlePdfInputChange(this)" />
      </div>


      <!-- ── Action Buttons ── -->
      <div id="actionArea">

        <!-- Idle hint -->
        <div id="idleHint" style="text-align:center; padding:16px 0; color:#334155; font-size:0.8rem; line-height:1.6;">
          Upload an <span style="color:#3b82f6;">Excel file</span> for Auto Mode<br>or drop <span style="color:#22c55e;">PDF files</span> for Manual Mode
        </div>

        <!-- Auto Mode Actions -->
        <div id="autoActions" style="display:none; flex-direction:column; gap:8px;">
          <button id="runAutoBtn" class="btn btn-primary" style="width:100%; justify-content:center;" onclick="runAutoMerge()">
            <!-- Zap icon -->
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
            </svg>
            Run Auto Merge
          </button>
          <button id="downloadZipBtn" class="btn btn-success" style="width:100%; justify-content:center; display:none;" onclick="downloadAllAsZip()">
            <!-- Archive icon -->
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Download All as ZIP
          </button>
        </div>

        <!-- Manual Mode Actions -->
        <div id="manualActions" style="display:none;">
          <button id="quickMergeBtn" class="btn btn-primary" style="width:100%; justify-content:center;" onclick="runManualMerge()">
            <!-- Merge icon -->
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M6 21V9a9 9 0 0 0 9 9"/>
            </svg>
            Quick Merge &amp; Download
          </button>
          <div style="font-size:0.7rem; color:#334155; text-align:center; margin-top:7px;">Drag cards above to reorder before merging</div>
        </div>

      </div><!-- /actionArea -->

      <!-- Progress Bar (hidden until processing) -->
      <div id="progressContainer" style="display:none;">
        <div style="height:4px; background:#1e293b; border-radius:2px; overflow:hidden;">
          <div id="progressBar" style="height:100%; background:linear-gradient(90deg,#2563eb,#3b82f6); width:0%;"></div>
        </div>
        <div id="progressLabel" style="font-size:0.7rem; color:#64748b; margin-top:5px; text-align:center;"></div>
      </div>

    </div><!-- /LEFT PANEL -->


    <!-- ═══════════════ RIGHT PANEL ═══════════════ -->
    <div style="display:flex; flex-direction:column; gap:20px;">

      <!-- ── Queue Section ── -->
      <div>
        <div class="section-label" style="justify-content:space-between;">
          <div style="display:flex; align-items:center; gap:7px;">
            <!-- List icon -->
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>
            </svg>
            Document Queue
          </div>
          <span id="queueCount" style="font-family:monospace; font-size:0.72rem; color:#334155; font-weight:400; text-transform:none; letter-spacing:0;">0 files</span>
        </div>

        <div id="queueWrapper">
          <!-- Manual Mode: sortable PDF cards -->
          <div id="pdfQueue"></div>
          <!-- Auto Mode: container groups -->
          <div id="containerGroupsView" style="display:none;"></div>
        </div>

        <!-- Failure Report (auto mode) -->
        <div id="failureReport" style="display:none; margin-top:10px;">
          <div style="font-size:0.75rem; font-weight:700; color:#f87171; margin-bottom:8px; display:flex; align-items:center; gap:6px;">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            FAILURE REPORT
          </div>
          <div id="failureList"></div>
        </div>
      </div>


      <!-- ── Status Log ── -->
      <div>
        <div class="section-label" style="justify-content:space-between;">
          <div style="display:flex; align-items:center; gap:7px;">
            <!-- Terminal icon -->
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/>
            </svg>
            Status Log
          </div>
          <button onclick="clearLog()" style="background:none; border:none; cursor:pointer; color:#334155; font-size:0.7rem; font-weight:400; text-transform:none; letter-spacing:0;" onmouseover="this.style.color='#64748b'" onmouseout="this.style.color='#334155'">clear</button>
        </div>
        <div id="statusLog"></div>
      </div>

    </div><!-- /RIGHT PANEL -->

  </div><!-- /mainGrid -->
</main>


<!-- ═══════════════════════════════════════════ SCRIPT ═══════════════════════════════════════════ -->
<script>
'use strict';

// ══════════════════════════════════════════════════════════
//  STATE
// ══════════════════════════════════════════════════════════
const state = {
  mode: 'idle',        // 'idle' | 'auto' | 'manual'
  pdfs: [],            // Array<{id, name, size, file}>
  excelRows: [],       // Array<{containerNumber: string}>
  mergeResults: [],    // Array<{containerNumber, bytes, filename}>
  isProcessing: false,
};

let sortableInstance = null;

// ══════════════════════════════════════════════════════════
//  UTILITIES
// ══════════════════════════════════════════════════════════
function uid() { return Math.random().toString(36).slice(2, 10); }

function fmtSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / 1048576).toFixed(1) + ' MB';
}

function escHtml(str) {
  const d = document.createElement('div');
  d.appendChild(document.createTextNode(String(str)));
  return d.innerHTML;
}

function readAsArrayBuffer(file) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload  = e => res(e.target.result);
    r.onerror = () => rej(new Error('Cannot read: ' + file.name));
    r.readAsArrayBuffer(file);
  });
}

function triggerDownload(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a   = Object.assign(document.createElement('a'), { href: url, download: filename });
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 2000);
}

function setProgress(pct, label) {
  const bar = document.getElementById('progressBar');
  const lbl = document.getElementById('progressLabel');
  const con = document.getElementById('progressContainer');
  if (pct === null) {
    con.style.display = 'none';
    return;
  }
  con.style.display = 'block';
  bar.style.width = pct + '%';
  if (lbl && label !== undefined) lbl.textContent = label;
}


// ══════════════════════════════════════════════════════════
//  LOGGING
// ══════════════════════════════════════════════════════════
const LOG_PREFIXES = { info: '[INFO]', success: '[OK]  ', error: '[ERR] ', warning: '[WARN]' };
const LOG_COLORS   = { info: '#4b5563', success: '#4ade80', error: '#f87171', warning: '#fbbf24' };

function addLog(level, message) {
  const log = document.getElementById('statusLog');
  const time = new Date().toLocaleTimeString('en-US', { hour12: false });
  const div  = document.createElement('div');
  div.style.color = LOG_COLORS[level] || LOG_COLORS.info;
  div.innerHTML =
    `<span style="color:#1e293b;">${time}</span> ` +
    `<span style="font-weight:700;">${LOG_PREFIXES[level]}</span> ` +
    escHtml(message);
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

function clearLog() {
  const log = document.getElementById('statusLog');
  log.innerHTML = '';
  addLog('info', '// Log cleared');
}


// ══════════════════════════════════════════════════════════
//  MODE MANAGEMENT
// ══════════════════════════════════════════════════════════
function setMode(mode) {
  state.mode = mode;
  const badge = document.getElementById('modeBadge');
  const dot   = document.getElementById('modeDot');
  const label = document.getElementById('modeLabel');

  badge.className = 'mode-badge';

  const idleHint     = document.getElementById('idleHint');
  const autoActions  = document.getElementById('autoActions');
  const manualActions= document.getElementById('manualActions');
  const pdfQueue     = document.getElementById('pdfQueue');
  const groupsView   = document.getElementById('containerGroupsView');

  if (mode === 'idle') {
    badge.classList.add('mode-idle');
    dot.className = 'badge-dot idle-dot';
    label.textContent = 'Idle';
    idleHint.style.display = '';
    autoActions.style.display = 'none';
    manualActions.style.display = 'none';
    pdfQueue.style.display = '';
    groupsView.style.display = 'none';
  } else if (mode === 'auto') {
    badge.classList.add('mode-auto');
    dot.className = 'badge-dot auto-dot';
    label.textContent = 'Auto Mode';
    idleHint.style.display = 'none';
    autoActions.style.display = 'flex';
    manualActions.style.display = 'none';
    pdfQueue.style.display = 'none';
    groupsView.style.display = '';
  } else if (mode === 'manual') {
    badge.classList.add('mode-manual');
    dot.className = 'badge-dot manual-dot';
    label.textContent = 'Manual Mode';
    idleHint.style.display = 'none';
    autoActions.style.display = 'none';
    manualActions.style.display = '';
    pdfQueue.style.display = '';
    groupsView.style.display = 'none';
  }

  updateQueueCount();
}

function updateQueueCount() {
  const el = document.getElementById('queueCount');
  const n  = state.pdfs.length;
  el.textContent = n === 0 ? '0 files' : `${n} file${n !== 1 ? 's' : ''}`;
}


// ══════════════════════════════════════════════════════════
//  EXCEL HANDLING
// ══════════════════════════════════════════════════════════
function handleExcelInputChange(input) {
  if (input.files && input.files[0]) handleExcelFile(input.files[0]);
}

async function handleExcelFile(file) {
  addLog('info', `Parsing: ${file.name}`);
  try {
    const buf = await readAsArrayBuffer(file);
    const wb  = XLSX.read(buf, { type: 'array' });
    const ws  = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws);

    if (rows.length === 0) {
      addLog('error', 'Excel file is empty or unreadable');
      return;
    }

    // Flexible column detection for "Container Number"
    const containers = [];
    for (const row of rows) {
      const key = Object.keys(row).find(k => {
        const n = k.toLowerCase().replace(/[\s_\-#]/g, '');
        return n === 'containernumber' || n === 'container' || n === 'containerid' || n === 'containerno';
      });
      if (key && row[key]) {
        const cn = String(row[key]).trim();
        if (cn && !containers.includes(cn)) containers.push(cn);
      }
    }

    if (containers.length === 0) {
      addLog('error', 'No "Container Number" column found');
      addLog('warning', `Found columns: ${Object.keys(rows[0]).join(', ')}`);
      addLog('info', 'Expected a column named "Container Number" or "Container"');
      return;
    }

    state.excelRows = containers.map(c => ({ containerNumber: c }));
    addLog('success', `Parsed ${containers.length} container numbers from "${file.name}"`);
    containers.slice(0, 5).forEach(c => addLog('info', `  ↳ ${c}`));
    if (containers.length > 5) addLog('info', `  ↳ ...and ${containers.length - 5} more`);

    // Update drop zone UI
    const dz   = document.getElementById('excelDropZone');
    const drop = document.getElementById('excelDropContent');
    const loaded = document.getElementById('excelLoadedState');
    dz.classList.add('has-file');
    drop.style.display = 'none';
    loaded.style.display = 'flex';
    document.getElementById('excelFileName').textContent = file.name;
    document.getElementById('excelFileSub').textContent = `${containers.length} container numbers ready`;

    setMode('auto');
    renderContainerGroups();
    addLog('info', 'Now upload the PDF documents to match against these containers');

  } catch (err) {
    addLog('error', 'Failed to parse Excel: ' + err.message);
  }
}

function removeExcel() {
  state.excelRows = [];
  document.getElementById('excelInput').value = '';
  document.getElementById('excelDropZone').classList.remove('has-file');
  document.getElementById('excelDropContent').style.display = '';
  document.getElementById('excelLoadedState').style.display = 'none';
  document.getElementById('containerGroupsView').innerHTML = '';
  document.getElementById('failureReport').style.display = 'none';
  document.getElementById('downloadZipBtn').style.display = 'none';
  state.mergeResults = [];

  setMode(state.pdfs.length > 0 ? 'manual' : 'idle');
  addLog('info', 'Excel manifest removed — switched to Manual Mode');
}


// ══════════════════════════════════════════════════════════
//  PDF HANDLING
// ══════════════════════════════════════════════════════════
function handlePdfInputChange(input) {
  if (input.files && input.files.length > 0) {
    handlePdfFiles(Array.from(input.files));
    input.value = '';
  }
}

function handlePdfFiles(files) {
  const pdfs    = files.filter(f => /\.pdf$/i.test(f.name));
  const skipped = files.length - pdfs.length;
  if (skipped > 0) addLog('warning', `Skipped ${skipped} non-PDF file(s)`);
  if (pdfs.length === 0) return;

  const newPdfs = pdfs.map(f => ({ id: uid(), name: f.name, size: f.size, file: f }));
  state.pdfs.push(...newPdfs);
  addLog('info', `Added ${newPdfs.length} PDF${newPdfs.length !== 1 ? 's' : ''} to queue`);

  if (state.mode !== 'auto') setMode('manual');

  renderPdfQueue();
  if (state.mode === 'auto') renderContainerGroups();
  updateQueueCount();
}

function removePdf(id) {
  state.pdfs = state.pdfs.filter(p => p.id !== id);
  renderPdfQueue();
  if (state.mode === 'auto') renderContainerGroups();
  updateQueueCount();
  if (state.pdfs.length === 0 && state.mode === 'manual') setMode('idle');
}


// ══════════════════════════════════════════════════════════
//  RENDERING — PDF Queue
// ══════════════════════════════════════════════════════════
const ICON_PDF = `<svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>`;
const ICON_GRIP = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>`;
const ICON_TRASH = `<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/></svg>`;

const EMPTY_QUEUE_HTML = `
  <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:170px; text-align:center; padding:20px;">
    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#1e293b" stroke-width="1.5" style="margin-bottom:12px;">
      <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/>
    </svg>
    <div style="font-size:0.8rem; color:#334155;">No documents in queue</div>
    <div style="font-size:0.72rem; color:#1e293b; margin-top:4px;">Drop PDFs above to get started</div>
  </div>`;

function renderPdfQueue() {
  const queue = document.getElementById('pdfQueue');

  if (state.pdfs.length === 0) {
    queue.innerHTML = EMPTY_QUEUE_HTML;
    if (sortableInstance) { sortableInstance.destroy(); sortableInstance = null; }
    return;
  }

  queue.innerHTML = state.pdfs.map((pdf, i) => `
    <div class="pdf-card" data-id="${pdf.id}">
      <span class="drag-handle" title="Drag to reorder">${ICON_GRIP}</span>
      ${ICON_PDF}
      <div style="flex:1; min-width:0;">
        <div style="font-size:0.8125rem; font-weight:500; color:#e2e8f0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escHtml(pdf.name)}</div>
        <div style="font-size:0.68rem; color:#475569; margin-top:2px;">${fmtSize(pdf.size)} &nbsp;·&nbsp; Position ${i + 1}</div>
      </div>
      <button
        onclick="removePdf('${pdf.id}')"
        style="background:none; border:none; cursor:pointer; color:#475569; flex-shrink:0; padding:5px; border-radius:5px; line-height:0;"
        onmouseover="this.style.color='#f87171'; this.style.background='rgba(127,29,29,0.3)'"
        onmouseout="this.style.color='#475569'; this.style.background='none'"
        title="Remove">${ICON_TRASH}
      </button>
    </div>`).join('');

  updateQueueCount();
  initSortable();
}


// ══════════════════════════════════════════════════════════
//  RENDERING — Container Groups (Auto Mode)
// ══════════════════════════════════════════════════════════
const ICON_CHECK = `<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>`;
const ICON_WARN  = `<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`;

function renderContainerGroups() {
  const view = document.getElementById('containerGroupsView');
  if (state.excelRows.length === 0) { view.innerHTML = ''; return; }

  view.innerHTML = state.excelRows.map(row => {
    const matched = state.pdfs.filter(p =>
      p.name.toLowerCase().includes(row.containerNumber.toLowerCase())
    );
    const isMatch = matched.length > 0;

    return `
      <div class="container-group ${isMatch ? 'matched' : 'unmatched'}">
        <div class="container-group-header">
          ${isMatch ? ICON_CHECK : ICON_WARN}
          <span style="font-size:0.8rem; font-weight:700; color:#e2e8f0; font-family:monospace; letter-spacing:0.02em;">${escHtml(row.containerNumber)}</span>
          <span style="margin-left:auto; font-size:0.7rem; font-weight:600; color:${isMatch ? '#22c55e' : '#f59e0b'};">
            ${isMatch ? `${matched.length} file${matched.length !== 1 ? 's' : ''} matched` : 'No match'}
          </span>
        </div>
        ${matched.map(p => `
          <div class="matched-file-row">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>
            <span style="font-size:0.72rem; color:#94a3b8; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1; max-width:240px;">${escHtml(p.name)}</span>
            <span style="font-size:0.67rem; color:#334155; flex-shrink:0;">${fmtSize(p.size)}</span>
          </div>`).join('')}
        ${!isMatch ? `<div style="font-size:0.7rem; color:#475569; padding:3px 6px;">Upload a PDF with "${escHtml(row.containerNumber)}" in the filename</div>` : ''}
      </div>`;
  }).join('');

  updateQueueCount();
}


// ══════════════════════════════════════════════════════════
//  SORTABLE
// ══════════════════════════════════════════════════════════
function initSortable() {
  if (sortableInstance) { sortableInstance.destroy(); sortableInstance = null; }
  if (state.pdfs.length <= 1) return;

  sortableInstance = new Sortable(document.getElementById('pdfQueue'), {
    animation: 200,
    easing: 'cubic-bezier(0.25, 1, 0.5, 1)',
    ghostClass: 'sortable-ghost',
    chosenClass: 'sortable-chosen',
    dragClass: 'sortable-drag',
    handle: '.drag-handle',
    onEnd(evt) {
      const moved = state.pdfs.splice(evt.oldIndex, 1)[0];
      state.pdfs.splice(evt.newIndex, 0, moved);
      setTimeout(() => renderPdfQueue(), 0);
    },
  });
}


// ══════════════════════════════════════════════════════════
//  PDF MERGING (core)
// ══════════════════════════════════════════════════════════
async function mergePdfFiles(pdfs) {
  const { PDFDocument } = PDFLib;
  const merged = await PDFDocument.create();

  for (const pdf of pdfs) {
    try {
      const buf  = await readAsArrayBuffer(pdf.file);
      const doc  = await PDFDocument.load(buf, { ignoreEncryption: true });
      const pages = await merged.copyPages(doc, doc.getPageIndices());
      pages.forEach(p => merged.addPage(p));
    } catch (err) {
      throw new Error(`"${pdf.name}": ${err.message}`);
    }
  }

  return merged.save();
}


// ══════════════════════════════════════════════════════════
//  AUTO MERGE
// ══════════════════════════════════════════════════════════
async function runAutoMerge() {
  if (state.isProcessing) return;
  if (!state.excelRows.length) { addLog('error', 'No Excel manifest loaded'); return; }
  if (!state.pdfs.length)      { addLog('error', 'No PDFs uploaded'); return; }

  state.isProcessing = true;
  state.mergeResults = [];

  const btn = document.getElementById('runAutoBtn');
  btn.disabled = true;
  btn.innerHTML = `<svg class="spinner" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Processing…`;

  document.getElementById('failureReport').style.display = 'none';
  document.getElementById('downloadZipBtn').style.display = 'none';
  setProgress(0, 'Starting…');

  addLog('info', '──── Auto Merge started ────');
  const failures = [];
  const total = state.excelRows.length;

  for (let i = 0; i < total; i++) {
    const row = state.excelRows[i];
    setProgress(Math.round((i / total) * 100), `Processing ${i + 1} / ${total}: ${row.containerNumber}`);
    addLog('info', `Searching → ${row.containerNumber}`);

    const matched = state.pdfs.filter(p =>
      p.name.toLowerCase().includes(row.containerNumber.toLowerCase())
    );

    if (!matched.length) {
      addLog('warning', `No match for ${row.containerNumber} — skipped`);
      failures.push({ containerNumber: row.containerNumber, reason: 'No matching PDF filename' });
      continue;
    }

    addLog('info', `  Found: ${matched.map(m => m.name).join(', ')}`);

    try {
      const bytes = await mergePdfFiles(matched);
      state.mergeResults.push({
        containerNumber: row.containerNumber,
        bytes,
        filename: `${row.containerNumber}_Merged.pdf`,
      });
      addLog('success', `  → ${row.containerNumber}_Merged.pdf (${fmtSize(bytes.length)})`);
    } catch (err) {
      addLog('error', `Failed to merge ${row.containerNumber}: ${err.message}`);
      failures.push({ containerNumber: row.containerNumber, reason: err.message });
    }
  }

  setProgress(100, 'Done');
  setTimeout(() => setProgress(null), 1500);

  addLog('info', '──────────────────────────');
  addLog('success', `Complete: ${state.mergeResults.length} merged · ${failures.length} failed`);

  if (failures.length > 0) {
    addLog('warning', `Failures: ${failures.map(f => f.containerNumber).join(', ')}`);
    renderFailureReport(failures);
  }

  if (state.mergeResults.length > 0) {
    document.getElementById('downloadZipBtn').style.display = 'flex';
    addLog('info', 'Click "Download All as ZIP" to get your merged files');
  }

  btn.disabled = false;
  btn.innerHTML = `<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg> Run Auto Merge`;
  state.isProcessing = false;
}

function renderFailureReport(failures) {
  const rpt = document.getElementById('failureReport');
  const lst = document.getElementById('failureList');
  lst.innerHTML = failures.map(f => `
    <div class="failure-row">
      <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="#f87171" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      <span style="font-family:monospace; color:#fca5a5;">${escHtml(f.containerNumber)}</span>
      <span style="color:#6b7280; font-size:0.72rem; margin-left:auto;">${escHtml(f.reason)}</span>
    </div>`).join('');
  rpt.style.display = 'block';
}


// ══════════════════════════════════════════════════════════
//  MANUAL MERGE
// ══════════════════════════════════════════════════════════
async function runManualMerge() {
  if (state.isProcessing) return;
  if (!state.pdfs.length) { addLog('error', 'No PDFs in queue'); return; }

  state.isProcessing = true;

  const btn = document.getElementById('quickMergeBtn');
  btn.disabled = true;
  btn.innerHTML = `<svg class="spinner" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg> Merging…`;

  setProgress(30, `Merging ${state.pdfs.length} PDFs…`);
  addLog('info', `Manual merge: ${state.pdfs.length} file${state.pdfs.length !== 1 ? 's' : ''} in order:`);
  state.pdfs.forEach((p, i) => addLog('info', `  ${i + 1}. ${p.name}`));

  try {
    const bytes = await mergePdfFiles(state.pdfs);
    setProgress(100, 'Done!');
    const blob = new Blob([bytes], { type: 'application/pdf' });
    triggerDownload(blob, 'NGL_Merged.pdf');
    addLog('success', `Downloaded: NGL_Merged.pdf (${fmtSize(bytes.length)})`);
  } catch (err) {
    addLog('error', 'Merge failed: ' + err.message);
  }

  setTimeout(() => setProgress(null), 1500);
  btn.disabled = false;
  btn.innerHTML = `<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M6 21V9a9 9 0 0 0 9 9"/></svg> Quick Merge &amp; Download`;
  state.isProcessing = false;
}


// ══════════════════════════════════════════════════════════
//  ZIP DOWNLOAD
// ══════════════════════════════════════════════════════════
async function downloadAllAsZip() {
  if (!state.mergeResults.length) {
    addLog('error', 'No merged results yet. Run Auto Merge first.');
    return;
  }

  addLog('info', `Building ZIP: ${state.mergeResults.length} file${state.mergeResults.length !== 1 ? 's' : ''}…`);
  setProgress(50, 'Building ZIP…');

  const zip = new JSZip();
  state.mergeResults.forEach(r => zip.file(r.filename, r.bytes));

  try {
    const blob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 6 } });
    setProgress(100, 'ZIP ready!');
    triggerDownload(blob, 'NGL_Merged_Documents.zip');
    addLog('success', `Downloaded: NGL_Merged_Documents.zip (${fmtSize(blob.size)})`);
  } catch (err) {
    addLog('error', 'ZIP failed: ' + err.message);
  }

  setTimeout(() => setProgress(null), 1500);
}


// ══════════════════════════════════════════════════════════
//  CLEAR ALL
// ══════════════════════════════════════════════════════════
function clearAll() {
  state.pdfs         = [];
  state.excelRows    = [];
  state.mergeResults = [];
  state.isProcessing = false;

  document.getElementById('pdfInput').value   = '';
  document.getElementById('excelInput').value = '';

  // Reset excel zone
  document.getElementById('excelDropZone').classList.remove('has-file');
  document.getElementById('excelDropContent').style.display    = '';
  document.getElementById('excelLoadedState').style.display    = 'none';

  // Reset queue
  document.getElementById('pdfQueue').innerHTML          = EMPTY_QUEUE_HTML;
  document.getElementById('containerGroupsView').innerHTML = '';
  document.getElementById('failureReport').style.display  = 'none';
  document.getElementById('downloadZipBtn').style.display = 'none';

  if (sortableInstance) { sortableInstance.destroy(); sortableInstance = null; }

  setProgress(null);
  setMode('idle');
  addLog('info', 'All files cleared — ready for new job');
}


// ══════════════════════════════════════════════════════════
//  DROP ZONE EVENTS
// ══════════════════════════════════════════════════════════
function setupDrop(zoneId, onDrop) {
  const zone = document.getElementById(zoneId);

  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
  zone.addEventListener('dragleave', e => { if (!zone.contains(e.relatedTarget)) zone.classList.remove('drag-over'); });
  zone.addEventListener('drop', e => {
    e.preventDefault();
    zone.classList.remove('drag-over');
    onDrop(Array.from(e.dataTransfer.files));
  });
}

setupDrop('excelDropZone', files => {
  const excel = files.find(f => /\.(xlsx|xls|csv)$/i.test(f.name));
  if (excel) handleExcelFile(excel);
  else {
    // Maybe they dropped PDFs here — forward to PDF handler
    const pdfs = files.filter(f => /\.pdf$/i.test(f.name));
    if (pdfs.length) { addLog('warning', 'Dropped PDFs in the Excel zone — adding to PDF queue'); handlePdfFiles(pdfs); }
    else addLog('warning', 'Expected an .xlsx, .xls, or .csv file');
  }
});

setupDrop('pdfDropZone', files => {
  const excel = files.find(f => /\.(xlsx|xls|csv)$/i.test(f.name));
  if (excel) { addLog('info', 'Detected Excel file in PDF zone — processing as manifest'); handleExcelFile(excel); }
  handlePdfFiles(files.filter(f => /\.pdf$/i.test(f.name)));
});


// ══════════════════════════════════════════════════════════
//  RESPONSIVE GRID
// ══════════════════════════════════════════════════════════
function applyResponsiveLayout() {
  const grid = document.getElementById('mainGrid');
  if (window.innerWidth < 900) {
    grid.style.gridTemplateColumns = '1fr';
  } else {
    grid.style.gridTemplateColumns = '1fr 1fr';
  }
}
window.addEventListener('resize', applyResponsiveLayout);
applyResponsiveLayout();


// ══════════════════════════════════════════════════════════
//  AGENT-READY API
//  ─────────────────────────────────────────────────────────
//  This object is exposed on window.__nglAgent so a future
//  automation agent (Python watcher, Zapier webhook, or LLM
//  tool call) can drive the app programmatically without
//  clicking buttons.
//
//  Architectural integration point for Phase 2:
//    1. Observer (Zapier / Python watchdog) detects new files
//    2. Brain (Claude API) identifies containers + PDF paths
//    3. Worker calls window.__nglAgent.processPayload(payload)
//       which feeds files directly into the merge pipeline
// ══════════════════════════════════════════════════════════
window.__nglAgent = {
  /**
   * Process a structured payload from an automation agent.
   *
   * @param {{
   *   containerNumbers: string[],
   *   pdfFileUrls: Array<{filename: string, url: string}>
   * }} payload
   */
  async processPayload(payload) {
    addLog('info', `[Agent] Received payload — ${payload.containerNumbers.length} containers`);

    // --- Future: fetch PDFs from URLs ---
    // const fetched = await Promise.all(
    //   payload.pdfFileUrls.map(async ({ filename, url }) => {
    //     const res  = await fetch(url);
    //     const blob = await res.blob();
    //     return { id: uid(), name: filename, size: blob.size, file: new File([blob], filename, { type: 'application/pdf' }) };
    //   })
    // );
    // state.pdfs.push(...fetched);
    // state.excelRows = payload.containerNumbers.map(c => ({ containerNumber: c }));
    // setMode('auto');
    // renderContainerGroups();
    // await runAutoMerge();

    return {
      received: true,
      containerCount: payload.containerNumbers.length,
      timestamp: new Date().toISOString(),
    };
  },

  /** Returns current application state for agent inspection. */
  getState() {
    return {
      mode: state.mode,
      pdfCount: state.pdfs.length,
      containerCount: state.excelRows.length,
      mergeResultCount: state.mergeResults.length,
      pdfNames: state.pdfs.map(p => p.name),
      containerNumbers: state.excelRows.map(r => r.containerNumber),
    };
  },
};


// ══════════════════════════════════════════════════════════
//  INIT
// ══════════════════════════════════════════════════════════
(function init() {
  renderPdfQueue();
  setMode('idle');
  addLog('info', '// NGL Document Merger v2.0');
  addLog('info', '// 100% client-side — no files leave your machine');
  addLog('info', '// Drop Excel for Auto Mode · Drop PDFs for Manual Mode');
})();
</script>

</body>
</html>
